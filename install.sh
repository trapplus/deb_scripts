#!/bin/bash
set -e

# Config
REPO_URL="https://github.com/trapplus/deb_scripts.git"
UV_INSTALL_URL="https://astral.sh/uv/install.sh"
INSTALL_DIR="$HOME/deb_scripts"
REPO_NAME="deb_scripts"

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
MAGENTA='\033[0;35m'
CYAN='\033[0;36m'
NC='\033[0m'
BOLD='\033[1m'

print_header() {
    echo -e "${CYAN}${BOLD}"
    echo "  â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "  â•‘         deb_scripts Installer          â•‘"
    echo "  â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

print_step() {
    echo -e "${BLUE}â–¶${NC} ${BOLD}$1${NC}"
}

print_success() {
    echo -e "${GREEN}âœ”${NC} $1"
}

print_error() {
    echo -e "${RED}âœ–${NC} $1"
}

print_info() {
    echo -e "${YELLOW}â„¹${NC} $1"
}

check_command() {
    if command -v "$1" &> /dev/null; then
        return 0
    else
        return 1
    fi
}

install_uv() {
    print_step "ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° uv..."

    if check_command uv; then
        print_success "uv ÑƒĞ¶Ğµ ÑƒÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ĞµĞ½"
        return 0
    fi

    print_step "Ğ£ÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºĞ° uv..."
    if curl -fsSL "$UV_INSTALL_URL" | sh; then
        print_success "uv ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾ ÑƒÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ĞµĞ½"

        export PATH="$HOME/.cargo/bin:$PATH"

        return 0
    else
        print_error "ĞĞµ ÑƒĞ´Ğ°Ğ»Ğ¾ÑÑŒ ÑƒÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ¸Ñ‚ÑŒ uv"
        return 1
    fi
}

clone_repository() {
    print_step "ĞšĞ»Ğ¾Ğ½Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ñ€ĞµĞ¿Ğ¾Ğ·Ğ¸Ñ‚Ğ¾Ñ€Ğ¸Ñ..."

    if [ -d "$INSTALL_DIR" ]; then
        print_info "Ğ”Ğ¸Ñ€ĞµĞºÑ‚Ğ¾Ñ€Ğ¸Ñ $INSTALL_DIR ÑƒĞ¶Ğµ ÑÑƒÑ‰ĞµÑÑ‚Ğ²ÑƒĞµÑ‚"
        read -p "$(echo -e ${YELLOW}Ğ£Ğ´Ğ°Ğ»Ğ¸Ñ‚ÑŒ Ğ¸ Ğ¿ĞµÑ€ĞµÑƒÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ¸Ñ‚ÑŒ? [y/N]:${NC} )" -n 1 -r
        echo
        if [[ $REPLY =~ ^[Yy]$ ]]; then
            rm -rf "$INSTALL_DIR"
        else
            print_info "ĞŸÑ€Ğ¾Ğ¿ÑƒÑĞºĞ°ĞµĞ¼ ĞºĞ»Ğ¾Ğ½Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ"
            return 0
        fi
    fi

    if ! check_command git; then
        print_error "Git Ğ½Ğµ ÑƒÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ĞµĞ½. Ğ£ÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ¸ git Ğ¸ Ğ¿Ğ¾Ğ¿Ñ€Ğ¾Ğ±ÑƒĞ¹ ÑĞ½Ğ¾Ğ²Ğ°"
        exit 1
    fi

    if git clone "$REPO_URL" "$INSTALL_DIR"; then
        print_success "Ğ ĞµĞ¿Ğ¾Ğ·Ğ¸Ñ‚Ğ¾Ñ€Ğ¸Ğ¹ ÑĞºĞ»Ğ¾Ğ½Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½ Ğ² $INSTALL_DIR"
        return 0
    else
        print_error "ĞĞµ ÑƒĞ´Ğ°Ğ»Ğ¾ÑÑŒ ÑĞºĞ»Ğ¾Ğ½Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ñ€ĞµĞ¿Ğ¾Ğ·Ğ¸Ñ‚Ğ¾Ñ€Ğ¸Ğ¹"
        return 1
    fi
}

run_script() {
    print_step "Ğ—Ğ°Ğ¿ÑƒÑĞº ÑĞºÑ€Ğ¸Ğ¿Ñ‚Ğ°..."

    cd "$INSTALL_DIR"

    if uv run main.py; then
        print_success "Ğ¡ĞºÑ€Ğ¸Ğ¿Ñ‚ Ğ²Ñ‹Ğ¿Ğ¾Ğ»Ğ½ĞµĞ½ ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾"
        return 0
    else
        print_error "ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ñ€Ğ¸ Ğ²Ñ‹Ğ¿Ğ¾Ğ»Ğ½ĞµĞ½Ğ¸Ğ¸ ÑĞºÑ€Ğ¸Ğ¿Ñ‚Ğ°"
        return 1
    fi
}

print_manual_run() {
    echo
    echo -e "${CYAN}${BOLD}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo -e "${GREEN}${BOLD}   Ğ£ÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºĞ° Ğ·Ğ°Ğ²ĞµÑ€ÑˆĞµĞ½Ğ°!${NC}"
    echo -e "${CYAN}${BOLD}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo
    echo -e "${BOLD}Ğ”Ğ»Ñ Ğ·Ğ°Ğ¿ÑƒÑĞºĞ° ÑĞºÑ€Ğ¸Ğ¿Ñ‚Ğ° Ğ²Ñ‹Ğ¿Ğ¾Ğ»Ğ½Ğ¸:${NC}"
    echo
    echo -e "  ${MAGENTA}cd $INSTALL_DIR && uv run main.py${NC}"
    echo
    echo -e "${YELLOW}ğŸ’¡ Ğ¡Ğ¾Ğ²ĞµÑ‚:${NC} Ğ”Ğ¾Ğ±Ğ°Ğ²ÑŒ Ğ°Ğ»Ğ¸Ğ°Ñ Ğ² ~/.bashrc Ğ¸Ğ»Ğ¸ ~/.zshrc:"
    echo
    echo -e "  ${CYAN}alias deb='cd $INSTALL_DIR && uv run main.py'${NC}"
    echo
    echo -e "${CYAN}${BOLD}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
}

# methods

main() {
    clear
    print_header

    if ! install_uv; then
        exit 1
    fi

    echo

    if ! clone_repository; then
        exit 1
    fi

    echo

    read -p "$(echo -e ${GREEN}${BOLD}Ğ—Ğ°Ğ¿ÑƒÑÑ‚Ğ¸Ñ‚ÑŒ ÑĞºÑ€Ğ¸Ğ¿Ñ‚ ÑĞµĞ¹Ñ‡Ğ°Ñ? [Y/n]:${NC} )" -n 1 -r
    echo
    echo

    if [[ $REPLY =~ ^[Nn]$ ]]; then
        print_manual_run
    else
        if run_script; then
            echo
            print_success "Ğ“Ğ¾Ñ‚Ğ¾Ğ²Ğ¾!"
            echo
            print_info "Ğ”Ğ»Ñ Ğ¿Ğ¾Ğ²Ñ‚Ğ¾Ñ€Ğ½Ğ¾Ğ³Ğ¾ Ğ·Ğ°Ğ¿ÑƒÑĞºĞ° Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞ¹:"
            echo -e "  ${MAGENTA}cd $INSTALL_DIR && uv run main.py${NC}"
            echo
        else
            echo
            print_manual_run
        fi
    fi

    if [[ ! ":$PATH:" == *":$HOME/.cargo/bin:"* ]]; then
        echo
        print_info "Ğ’Ğ¾Ğ·Ğ¼Ğ¾Ğ¶Ğ½Ğ¾, Ğ¿Ğ¾Ñ‚Ñ€ĞµĞ±ÑƒĞµÑ‚ÑÑ Ğ¿ĞµÑ€ĞµĞ·Ğ°Ğ³Ñ€ÑƒĞ·Ğ¸Ñ‚ÑŒ shell Ğ¸Ğ»Ğ¸ Ğ²Ñ‹Ğ¿Ğ¾Ğ»Ğ½Ğ¸Ñ‚ÑŒ:"
        echo -e "  ${CYAN}source ~/.bashrc${NC}  ${YELLOW}# Ğ¸Ğ»Ğ¸${NC}  ${CYAN}source ~/.zshrc${NC}"
        echo
    fi
}

main
